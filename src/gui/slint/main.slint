import { AboutSlint, VerticalBox, Button, StandardButton, SpinBox, CheckBox, LineEdit, ComboBox } from "std-widgets.slint";
import { PitchType, SampleConfig, SampleUtils, SampleConfigWidget } from "./sample-config.slint";
export { PitchType, SampleConfig, SampleUtils }
import { ColorUtils, ColorPickerButton } from "./color-picker.slint";
export { ColorUtils }

export enum StopConditionType {
    Frames, Time, SpcDuration
}

component FileBrowser {
    callback browse() -> string;
    callback cleared();

    in property <string> text: "File:";
    in property <bool> enabled: true;
    in property <bool> clearable: false;
    out property <string> path: "";

    HorizontalLayout {
        alignment: stretch;
        spacing: 8px;
        Text {
            text: root.text;
            vertical-alignment: center;
        }
        LineEdit {
            enabled: false;
            text: path;
            placeholder-text: "No file selected";
        }
        Button {
            text: "Browse...";
            enabled: root.enabled;
            clicked => {
                root.path = root.browse();
            }
        }
        if root.clearable: Button {
            text: "Clear";
            enabled: root.enabled;
            clicked => {
                root.path = "";
                root.cleared();
            }
        }
    }
}

export component MainWindow inherits Window {
    callback browse-for-module() -> string;
    callback browse-for-background() -> string;
    callback background-cleared();
    callback import-tunings();
    callback format-duration(StopConditionType, int) -> string;
    callback start-render();
    callback cancel-render();
    callback add-sample(int) -> int;
    callback remove-sample(int) -> int;

    in property <string> version: "?";
    in property <string> ffmpeg-version: "?";

    in property <bool> rendering;
    in property <float> progress: 0.0;
    in property <string> progress-title: "Idle";
    in property <string> progress-status: "";
    in property <bool> progress-error: false;
    in property <bool> progress-indeterminate: false;

    property<float> i-progress-anim-tick: -cos(180deg * mod(animation-tick() / 1.3s, 2) / 2) + 1;

    in property <[string]> metadata-lines: ["<no metadata>"];
    in-out property <[[int]]> channel-base-colors: [
        [255, 160, 160],
        [255, 224, 160],
        [64, 255, 64],
        [192, 192, 192],
        [154, 79, 255],
        [56, 171, 242],
        [172, 237, 50],
        [36, 123, 160]
    ];
    in-out property <[SampleConfig]> sample-configs: [];
    in-out property <int> fadeout-duration: 180;
    in-out property <int> output-width: 1920;
    in-out property <int> output-height: 1080;
    in-out property <bool> filter-enabled: true;
    in-out property <bool> accurate-interp: true;

    out property <StopConditionType> stop-condition-type: StopConditionType.Time;
    out property <int> stop-condition-num: 300;

    public function reformat-duration() {
        i-formatted-duration.text = root.format-duration(root.stop-condition-type, root.stop-condition-num);
    }

    title: "SPCPresenter";
    icon: @image-url("spc-presenter-icon.png");

    Rectangle {
        Button {
            icon: @image-url("info.svg");
            x: parent.width - self.width - 8px;
            y: 16px;
            clicked => {
                i-about-popup.show()
            }
        }
        i-about-popup := PopupWindow {
            x: parent.width - 308px;
            y: 16px;
            width: 300px;
            height: 300px;

            Rectangle {
                background: #1c1c1c;
                border-radius: 2px;

                VerticalBox {
                    alignment: start;
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;

                        Image {
                            width: 32px;
                            source: @image-url("spc-presenter-icon.png");
                            image-rendering: pixelated;
                        }
                        Text {
                            text: "SPCPresenter v" + root.version;
                            font-size: 24px;
                            vertical-alignment: center;
                        }
                    }
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;

                        Image {
                            width: 32px;
                            height: 32px;
                            source: @image-url("snes-apu-spcp-icon.png");
                            image-rendering: pixelated;
                        }
                        VerticalLayout {
                            alignment: center;

                            Text {
                                text: "snes-apu-spcp v" + root.version;
                                font-size: 14px;
                            }
                            Text {
                                text: "https://github.com/emu-rs/snes-apu";
                                font-size: 12px;
                            }
                        }
                    }
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;

                        Image {
                            width: 32px;
                            height: 32px;
                            source: @image-url("ffmpeg-icon.png");
                        }
                        VerticalLayout {
                            alignment: center;

                            Text {
                                text: "FFmpeg v" + root.ffmpeg-version;
                                font-size: 14px;
                            }
                            Text {
                                text: "https://ffmpeg.org/";
                                font-size: 12px;
                            }
                        }
                    }

                    AboutSlint {
                        preferred-height: 100px;
                    }
                    HorizontalLayout {
                        alignment: center;

                        Button { text: "Close"; }
                    }
                }
            }
        }
    }

    VerticalBox {
        alignment: start;
        spacing: 12px;

        Text {
            text: "SPCPresenter";
            font-size: 32px;
            horizontal-alignment: center;
        }
        FileBrowser {
            text: "Input SPC:";
            enabled: !root.rendering;
            browse => { root.browse-for-module() }
        }
        for line in metadata-lines: Text {
            horizontal-alignment: center;
            text: line;
        }

        HorizontalLayout {
            height: 28px;
            Text {
                text: "Base channel colors:";
                vertical-alignment: center;
            }
            Rectangle {
                width: 6px;
            }
            for color[i] in channel-base-colors: ColorPickerButton {
                color: color;
                enabled: !root.rendering;
                changed(r, g, b) => {
                    root.channel-base-colors[i] = [r, g, b];
                }
            }
        }
        HorizontalLayout {
            height: 28px;
            Text {
                text: "Sample configuration:";
                vertical-alignment: center;
            }
            Rectangle {
                horizontal-stretch: 2.0;
            }
            Button {
                text: "Import tunings...";
                enabled: !root.rendering;
                clicked => {
                    root.import-tunings();
                }
            }
        }

        SampleConfigWidget {
            sample-configs: root.sample-configs;
            enabled: !root.rendering;

            add-sample(s) => { root.add-sample(s) }
            remove-sample(i) => { root.remove-sample(i) }
        }

        FileBrowser {
            text: "Background:";
            enabled: !root.rendering;
            clearable: true;
            browse => { root.browse-for-background() }
            cleared => { root.background-cleared(); }
        }

        HorizontalLayout {
            alignment: stretch;
            spacing: 8px;
            Text {
                text: "Render duration:";
                vertical-alignment: center;
            }
            if stop-condition-type != StopConditionType.SpcDuration : LineEdit {
                enabled: !rendering;
                text: stop-condition-num;
                edited => {
                    if (self.text.is-float()) {
                        root.stop-condition-num = self.text.to-float();
                        root.reformat-duration();
                    }
                }
            }
            ComboBox {
                model: ["seconds", "frames", "SPC duration"];
                enabled: !rendering;
                selected => {
                    if (self.current-index == 0) {
                        root.stop-condition-type = StopConditionType.Time;
                    } else if (self.current-index == 1) {
                        root.stop-condition-type = StopConditionType.Frames;
                    } else if (self.current-index == 2) {
                        root.stop-condition-type = StopConditionType.SpcDuration;
                    }
                    root.reformat-duration();
                }
            }
            i-formatted-duration := Text {
                text: "00:05:00";
                vertical-alignment: center;
                color: self.text == "<error>"
                    ? red
                    : white;
            }
        }

        HorizontalLayout {
            alignment: stretch;
            spacing: 8px;
            Text {
                text: "Fadeout frames:";
                vertical-alignment: center;
            }
            SpinBox {
                value <=> root.fadeout-duration;
                minimum: 0;
                maximum: 1200;
                enabled: !root.rendering;
            }
        }

        HorizontalLayout {
            alignment: stretch;
            spacing: 8px;
            Text {
                text: "Output video size:";
                vertical-alignment: center;
            }
            SpinBox {
                value <=> root.output-width;
                minimum: 960;
                maximum: 7680;
                enabled: !root.rendering;
            }
            Text {
                text: "×";
                vertical-alignment: center;
            }
            SpinBox {
                value <=> root.output-height;
                minimum: 540;
                maximum: 4320;
                enabled: !root.rendering;
            }
            Button {
                text: "1080p";
                enabled: !rendering;
                clicked => {
                    root.output-width = 1920;
                    root.output-height = 1080;
                }
            }
            Button {
                text: "4K";
                enabled: !root.rendering;
                clicked => {
                    root.output-width = 3840;
                    root.output-height = 2160;
                }
            }
        }

        HorizontalLayout {
            alignment: center;
            spacing: 8px;
            CheckBox {
                text: "Use Blargg's DSP post-filter";
                checked <=> filter-enabled;
                enabled: !root.rendering;
            }
            CheckBox {
                text: "Accurate interpolation";
                checked <=> accurate-interp;
                enabled: !root.rendering;
            }
        }

        HorizontalLayout {
            alignment: center;
            Button {
                text: rendering
                    ? "Cancel"
                    : "Render!";
                primary: !root.rendering;
                clicked => {
                    if (root.rendering) {
                        root.cancel_render();
                    } else {
                        root.start_render();
                    }
                }
            }
        }

        VerticalBox {
            alignment: start;
            spacing: 8px;

            Text {
                text: root.progress-title;
                font-size: 16px;
            }
            Rectangle {
                height: 6px;
                clip: true;

                border-radius: 3px;
                background: #313131;  // Palette.neutralLighter

                if !root.progress-indeterminate: Rectangle {
                    x: 0;
                    y: 0;
                    height: parent.height;
                    width: Math.max(0.0, Math.min(root.progress, 1.0)) * parent.width;

                    border-width: 1px;
                    border-radius: 3px;
                    border-color: root.progress-error ? #bc2f32 : #60cdff;  // Palette.themePrimary
                    background: root.progress-error ? #bc2f32 : #60cdff;  // Palette.themePrimary

                    animate width {
                        duration: 100ms;
                        easing: ease-in-out;
                    }
                }
                if root.progress-indeterminate: Rectangle {
                    x: (4 * (root.i-progress-anim-tick / 1.4) - 1) * parent.width;
                    y: 0;
                    height: parent.height;
                    width: 0.5 * parent.width;

                    border-width: 1px;
                    border-radius: 3px;
                    border-color: root.i-progress-anim-tick > 1.4 ? transparent : #60cdff;  // Palette.themePrimary
                    background: root.i-progress-anim-tick > 1.4 ? transparent : #60cdff;  // Palette.themePrimary
                }
                if root.progress-indeterminate: Rectangle {
                    x: (3.1666 * ((root.i-progress-anim-tick - 0.6) / 1.4) - 1.5) * parent.width;
                    y: 0;
                    height: parent.height;
                    width: 0.8 * parent.width;

                    border-width: 1px;
                    border-radius: 3px;
                    border-color: root.i-progress-anim-tick < 0.6 ? transparent : #60cdff;  // Palette.themePrimary
                    background: root.i-progress-anim-tick < 0.6 ? transparent : #60cdff;  // Palette.themePrimary
                }
            }
            HorizontalLayout {
                alignment: start;
                spacing: 6px;

                if root.progress-error: Image {
                    colorize: #bc2f32;
                    height: 16px;
                    width: 16px;
                    source: @image-url("circle-error.svg");
                }
                Text {
                    text: root.progress-status;
                    color: root.progress-error ? #bc2f32 : #ffffff;
                    vertical-alignment: center;
                }
            }
        }
    }
}
